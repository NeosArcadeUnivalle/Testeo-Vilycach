const findRoot =  require('find-root')
const path = require('path')

class Plugi {
	constructor(prefix) {
		this.modules = {}
		this.root = findRoot(require.main.filename)
		this.prefix = prefix || '/app/plugi'
	}

	upgrade(name, payload) {
		const constructor = typeof payload === 'function' ? payload : this.require(name)
		if(typeof constructor !== 'function') {
			throw Error('Plugin constructor should be function')
		}
		this.modules[name] = constructor(this, payload)
	}


	require(name) {
		try {
			return require(`plugi-${name}`)
		} catch (e) {
			try {
				return require(path.join(this.root, this.prefix, name))
			} catch (e) {
				throw Error(`Plugin ${name} not found`)
			}
		}
	}

	module(name) {
		return this.modules[name]
	}
}

module.exports = Plugi
